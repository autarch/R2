<& /lib/contact-view/summary.mas, contact => $real_contact &>

% if ( $contact->donation_count() ) {
<table class="standard-table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Amount</th>
      <th>Source</th>
      <th>Target</th>
      <th>Payment Type</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
%   while ( my $donation = $donations->next() ) {
    <tr class="<% $donations->index() % 2 ? 'odd' : 'even' %>">
      <td><% $c->user()->format_date( $donation->donation_date() ) %></td>
      <td><% $donation->amount() %></td>
      <td><% $donation->source()->name() %></td>
      <td><% $donation->target()->name() %></td>
      <td><% $donation->payment_type()->name() %></td>
      <td>buttons</td>
    </tr>
%      if ( my $notes = $donation->notes() ) {
    <tr class="<% $donations->index() % 2 ? 'odd' : 'even' %> notes">
      <td colspan="6"><% $donation->notes() %></td>
    </tr>
%      }
%   }
  </tbody>
</table>
% } else {
<p>
This <% lc $contact->contact_type() %> has not made any donations.
</p>
% }

<&| /lib/filter/form.mas &>
<form action="<% $contact->uri( view => 'donations' ) %>" method="post">
  <fieldset>
    <legend>Add a new donation</legend>

    <div class="form-item">
      <label class="for-field" for="amount">Amount:</label>
      <input type="text" class="text narrow" name="amount" id="amount" />
      <div class="help-text">
        <p>
          Enter an amount in dollars and cents (50, 9.22).
        </p>
      </div>
    </div>

    <div class="form-item">
      <label class="for-field" for="donation_date">Date:</label>
      <input type="text" class="text narrow" name="donation_date" id="donation_date"
             value="<% $c->user()->format_date( DateTime->now( time_zone => $c->user()->timezone() ) ) %>" />
      <input type="hidden" name="date_format" value="<% $c->user()->date_format() %>" />
      <div class="help-text">
        <p>
          <% $c->user()->date_format() %>
        </p>
      </div>
    </div>

    <div class="form-item">
      <label class="for-field" for="source">Source:</label>
      <select name="donation_source_id">
% while ( my $source = $sources->next() ) {
        <option value="<% $source->donation_source_id() %>"><% $source->name() %></option>
% }
      </select>
    </div>

    <div class="form-item">
      <label class="for-field" for="target">Target:</label>
      <select name="donation_target_id">
% while ( my $target = $targets->next() ) {
        <option value="<% $target->donation_target_id() %>"><% $target->name() %></option>
% }
      </select>
    </div>

    <div class="form-item">
      <label class="for-field" for="payment_type">Payment Type:</label>
      <select name="payment_type_id">
% while ( my $type = $payment_types->next() ) {
        <option value="<% $type->payment_type_id() %>"><% $type->name() %></option>
% }
      </select>
    </div>

    <div class="form-item">
      <label class="for-field" for="note">Notes:</label>
      <textarea name="notes" class="short wide"></textarea>
    </div>

  </fieldset>
    
  <div class="form-item">
    <input class="submit" type="submit" value="Submit" />
  </div>

</form>
</&>

<%args>
$contact
$real_contact
</%args>

<%init>
my $sources = $c->user()->account()->donation_sources();
my $targets = $c->user()->account()->donation_targets();
my $payment_types = $c->user()->account()->payment_types();

my $donations = $contact->donations();
</%init>

<%method title>
Donations from <% $real_contact->display_name() %>
<%args>
$real_contact
</%args>
</%method>
